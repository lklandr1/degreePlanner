<!DOCTYPE html>
<html>
<head>
    <title>Advisor Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }
        h1 {
            color: #14213D;
            text-align: center;
            margin-bottom: 40px;
        }
        h2 {
            color: #14213D;
            margin-top: 0;
        }
        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        .nav-button {
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            border: none;
            background-color: #14213D;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .nav-button:hover {
            background-color: #0d1a2e;
        }
        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            background-color: #dc3545;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .logout-button:hover {
            background-color: #c82333;
        }
        .students-section {
            margin-top: 50px;
        }
        .students-section h2 {
            color: #14213D;
            margin-bottom: 20px;
            text-align: left;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: #fff;
        }
        thead {
            background-color: #14213D;
            color: #fff;
        }
        th, td {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .status {
            margin-top: 10px;
            font-weight: 600;
        }
        .status.error {
            color: #c82333;
        }
        .status.info {
            color: #14213D;
        }
        .search-input {
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }
        .changelog-section {
            display: none;
            margin-top: 50px;
        }
        .changelog-section.active {
            display: block;
        }
        .back-to-main {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            background-color: #6c757d;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 20px;
        }
        .back-to-main:hover {
            background-color: #5a6268;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-group label {
            font-weight: bold;
            color: #14213D;
        }
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
        }
        .reload-button {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            background-color: #14213D;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .reload-button:hover {
            background-color: #0d1a2e;
        }
        .no-changes {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-size: 16px;
        }
        .changelog-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .changelog-entry {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
            background-color: #fafafa;
            transition: all 0.2s ease;
        }
        .changelog-entry:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        .entry-title {
            font-weight: bold;
            color: #14213D;
            font-size: 16px;
            flex: 1;
        }
        .entry-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .entry-type.course {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .entry-type.major {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        .entry-meta {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .entry-description {
            background-color: white;
            padding: 10px 12px;
            border-left: 3px solid #14213D;
            margin-bottom: 12px;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }
        .entry-description-label {
            font-weight: bold;
            color: #14213D;
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .entry-notes {
            background-color: white;
            padding: 10px 12px;
            border-left: 3px solid #ffa500;
            font-size: 14px;
            color: #555;
            line-height: 1.5;
            font-style: italic;
        }
        .entry-notes-label {
            font-weight: bold;
            color: #14213D;
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        .entry-faculty {
            font-size: 12px;
            color: #888;
            text-align: right;
            margin-top: 10px;
            border-top: 1px solid #e0e0e0;
            padding-top: 8px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background-color: #ffebee;
            border: 1px solid #ef5350;
            border-radius: 5px;
            padding: 15px;
            color: #c62828;
            margin-bottom: 20px;
        }
        .empty-notes {
            color: #999;
            font-style: normal;
        }
        /* Student Management Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #14213D;
        }
        .modal-header h2 {
            margin: 0;
            color: #14213D;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }
        .close-modal:hover {
            color: #333;
        }
        .modal-section {
            margin-bottom: 30px;
        }
        .modal-section h3 {
            color: #14213D;
            margin-bottom: 15px;
        }
        .course-search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .course-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .course-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .course-result-item:hover {
            background-color: #f5f5f5;
        }
        .course-result-item input[type="checkbox"] {
            cursor: pointer;
        }
        .selected-courses {
            margin-top: 15px;
        }
        .selected-course {
            display: inline-block;
            background-color: #e3f2fd;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 5px;
            font-size: 14px;
        }
        .selected-course .remove-course {
            margin-left: 8px;
            cursor: pointer;
            color: #dc3545;
            font-weight: bold;
        }
        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            resize: vertical;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .modal-button.primary {
            background-color: #28a745;
            color: white;
        }
        .modal-button.primary:hover {
            background-color: #218838;
        }
        .modal-button.secondary {
            background-color: #6c757d;
            color: white;
        }
        .modal-button.secondary:hover {
            background-color: #5a6268;
        }
        tbody tr {
            cursor: pointer;
        }
        tbody tr:hover {
            background-color: #e8f4f8 !important;
        }
        tbody tr.pending-review {
            background-color: #fff3cd !important;
        }
        tbody tr.pending-review:hover {
            background-color: #ffe69c !important;
        }
        .filter-toggle {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            background-color: #ffc107;
            color: #333;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 15px;
        }
        .filter-toggle:hover {
            background-color: #e0a800;
        }
        .filter-toggle.active {
            background-color: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="logout-button" onclick="window.location.href='/logout'">
            Logout
        </button>
        <h1>Advisor Portal</h1>
        <div class="button-container">
            <button class="nav-button" onclick="window.location.href='advisor/individualStudents'">
                Individual Students
            </button>
            <button class="nav-button" onclick="showChangelogSection()">
                Curriculum Changes
            </button>
        </div>

        <div id="mainSection" class="students-section">
            <h2>Your Students</h2>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <button id="filterPendingBtn" class="filter-toggle" onclick="togglePendingFilter()">Show Pending Reviews</button>
                <input id="studentSearch" class="search-input" type="text" placeholder="Search students by name, email, or ID..." style="flex: 1;">
            </div>
            <div id="studentsStatus" class="status info">Loading students...</div>
            <table id="studentsTable" style="display:none;">
                <thead>
                    <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Major</th>
                        <th>Graduation Date</th>
                    </tr>
                </thead>
                <tbody id="studentsBody">
                </tbody>
            </table>
        </div>

        <!-- Student Management Modal -->
        <div id="studentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalStudentName">Student Management</h2>
                    <button class="close-modal" onclick="closeStudentModal()">&times;</button>
                </div>
                
                <div class="modal-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Add Completed Courses</h3>
                        <button class="modal-button secondary" onclick="viewStudentData()" style="margin: 0;">View Existing Data</button>
                    </div>
                    <input type="text" class="course-search-input" id="courseSearchInput" placeholder="Search for courses...">
                    <div class="course-results" id="courseResults"></div>
                    <div class="selected-courses" id="selectedCourses">
                        <strong>Selected Courses:</strong>
                        <div id="selectedCoursesList"></div>
                    </div>
                    <button class="modal-button primary" onclick="saveCompletedCourses()">Save Courses</button>
                </div>

                <div class="modal-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Schedule Review</h3>
                    </div>
                    <button id="reviewScheduleBtn" class="modal-button primary" onclick="reviewSchedule()" style="display: none; margin-bottom: 15px;">Review Schedule</button>
                </div>

                <div class="modal-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">Send Comment to Student</h3>
                    </div>
                    <textarea class="comment-textarea" id="commentText" placeholder="Enter your comment here..."></textarea>
                    <button class="modal-button primary" onclick="sendComment()">Send Comment</button>
                </div>

                <!-- View Data Modal -->
                <div id="viewDataModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2>Student Data</h2>
                            <button class="close-modal" onclick="closeViewDataModal()">&times;</button>
                        </div>
                        <div class="modal-section">
                            <h3>Completed Courses</h3>
                            <div id="completedCoursesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                        <div class="modal-section">
                            <h3>Sent Comments</h3>
                            <div id="commentsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-button secondary" onclick="closeViewDataModal()">Close</button>
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="modal-button secondary" onclick="closeStudentModal()">Close</button>
                </div>
            </div>
        </div>

        <!-- Schedule Review Modal -->
        <div id="scheduleReviewModal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h2 id="reviewModalStudentName">Review Schedule</h2>
                    <button class="close-modal" onclick="closeScheduleReviewModal()">&times;</button>
                </div>
                
                <div class="modal-section">
                    <div id="reviewScheduleContent" style="max-height: 600px; overflow-y: auto;">
                        <div class="loading">Loading schedule...</div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>Review Actions</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="modal-button primary" onclick="acceptSchedule()" style="background-color: #28a745;">Accept Schedule</button>
                        <button class="modal-button" onclick="showRejectForm()" style="background-color: #dc3545; color: white;">Reject Schedule</button>
                    </div>
                    <div id="rejectForm" style="display: none; margin-top: 15px;">
                        <textarea class="comment-textarea" id="rejectComment" placeholder="Enter reason for rejection..."></textarea>
                        <button class="modal-button" onclick="rejectSchedule()" style="background-color: #dc3545; color: white; margin-top: 10px;">Submit Rejection</button>
                        <button class="modal-button secondary" onclick="hideRejectForm()" style="margin-top: 10px;">Cancel</button>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="modal-button secondary" onclick="closeScheduleReviewModal()">Close</button>
                </div>
            </div>
        </div>

        <div id="changelogSection" class="changelog-section">
            <button class="back-to-main" onclick="hideChangelogSection()">← Back to Main</button>
            <h2>Curriculum Changes</h2>
            
            <div class="controls">
                <div class="filter-group">
                    <label for="filterType">Filter by Type:</label>
                    <select id="filterType" onchange="applyFilter()">
                        <option value="">All Changes</option>
                        <option value="course">Course Changes</option>
                        <option value="major">Major Changes</option>
                    </select>
                </div>
                <button class="reload-button" onclick="loadChanges()">Reload</button>
            </div>

            <div id="errorContainer"></div>
            <div id="loadingContainer" class="loading" style="display:none;">Loading changelog...</div>
            <div id="noChangesContainer" class="no-changes" style="display:none;">No changelog entries found.</div>
            <ul class="changelog-list" id="changelogList"></ul>
        </div>
    </div>
    <script>
        const ITEMS_PER_PAGE = 20;
        let allChanges = [];
        let filteredChanges = [];
        let currentPage = 1;
        let studentsCache = [];

        async function loadStudents() {
            const statusEl = document.getElementById('studentsStatus');
            const table = document.getElementById('studentsTable');
            const tbody = document.getElementById('studentsBody');
            const searchInput = document.getElementById('studentSearch');

            try {
                const response = await fetch('/api/secure/advisors/me/students');
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Failed to load students.');
                }

                const students = await response.json();

                if (!Array.isArray(students) || students.length === 0) {
                    statusEl.textContent = 'No students assigned yet.';
                    statusEl.className = 'status info';
                    table.style.display = 'none';
                    return;
                }
                studentsCache = students;
                renderStudents(studentsCache, tbody, table, statusEl);
                statusEl.textContent = '';
                table.style.display = 'table';

                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.trim().toLowerCase();
                    if (!query) {
                        renderStudents(studentsCache, tbody, table, statusEl);
                        statusEl.textContent = '';
                        return;
                    }
                    const filtered = studentsCache.filter(student => {
                        const searchFields = ['studentID', 'name', 'email', 'majorID'];
                        // Also search in graduation date if it exists
                        if (student.graduationDate) {
                            const gradDateStr = `${student.graduationDate.semester || ''} ${student.graduationDate.year || ''}`.toLowerCase();
                            if (gradDateStr.includes(query)) {
                                return true;
                            }
                        }
                        return searchFields.some(key => {
                            const value = String(student[key] ?? '').toLowerCase();
                            return value.includes(query);
                        });
                    });
                    if (filtered.length === 0) {
                        tbody.innerHTML = '';
                        table.style.display = 'none';
                        statusEl.textContent = 'No students match your search.';
                        statusEl.className = 'status info';
                    } else {
                        renderStudents(filtered, tbody, table, statusEl);
                        statusEl.textContent = '';
                    }
                });

            } catch (error) {
                console.error('Failed to fetch advisor students:', error);
                table.style.display = 'none';
                const message = error.message || 'Unable to load students right now.';
                statusEl.textContent = message;
                statusEl.className = 'status error';
            }
        }

        let showPendingOnly = false;

        function togglePendingFilter() {
            showPendingOnly = !showPendingOnly;
            const filterBtn = document.getElementById('filterPendingBtn');
            if (showPendingOnly) {
                filterBtn.textContent = 'Show All Students';
                filterBtn.classList.add('active');
            } else {
                filterBtn.textContent = 'Show Pending Reviews';
                filterBtn.classList.remove('active');
            }
            // Re-render with current filter
            if (studentsCache) {
                renderStudents(studentsCache, document.getElementById('studentsBody'), document.getElementById('studentsTable'), document.getElementById('studentsStatus'));
            }
        }

        function renderStudents(students, tbody, table, statusEl) {
            const escapeHtml = value => String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            // Filter students if pending filter is active
            let filteredStudents = students;
            if (showPendingOnly) {
                filteredStudents = students.filter(student => student.scheduleSubmissionStatus === 'pending');
            }

            if (filteredStudents.length === 0) {
                tbody.innerHTML = '';
                table.style.display = 'none';
                if (statusEl) {
                    statusEl.textContent = showPendingOnly ? 'No students with pending reviews.' : 'No students found.';
                    statusEl.className = 'status info';
                }
                return;
            }

            tbody.innerHTML = filteredStudents.map(student => {
                let graduationDate = 'N/A';
                if (student.graduationDate && student.graduationDate.semester && student.graduationDate.year) {
                    graduationDate = `${escapeHtml(student.graduationDate.semester)} ${escapeHtml(student.graduationDate.year)}`;
                }
                const pendingClass = student.scheduleSubmissionStatus === 'pending' ? 'pending-review' : '';
                return `
                <tr class="${pendingClass}" onclick="openStudentModal('${escapeHtml(student.id)}', '${escapeHtml(student.name)}', '${escapeHtml(student.studentID)}', '${escapeHtml(student.scheduleSubmissionStatus || 'none')}')">
                    <td>${escapeHtml(student.studentID)}</td>
                    <td>${escapeHtml(student.name)}</td>
                    <td>${escapeHtml(student.email)}</td>
                    <td>${escapeHtml(student.majorID)}</td>
                    <td>${graduationDate}</td>
                </tr>
            `;
            }).join('');
            table.style.display = 'table';
            if (statusEl) {
                statusEl.textContent = '';
            }
        }

        // Changelog functions
        function showChangelogSection() {
            document.getElementById('mainSection').style.display = 'none';
            document.getElementById('changelogSection').classList.add('active');
            loadChanges();
        }

        function hideChangelogSection() {
            document.getElementById('changelogSection').classList.remove('active');
            document.getElementById('mainSection').style.display = 'block';
        }

        async function loadChanges() {
            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const noChangesContainer = document.getElementById('noChangesContainer');
            const changelogList = document.getElementById('changelogList');

            loadingContainer.style.display = 'block';
            errorContainer.innerHTML = '';
            changelogList.innerHTML = '';
            noChangesContainer.style.display = 'none';

            try {
                const response = await fetch('/api/changelog/all?limit=500');
                if (!response.ok) {
                    console.log('Failed to fetch changelog:', response.statusText, response.status);
                    throw new Error('Failed to load changelog');
                }

                allChanges = await response.json();
                currentPage = 1;
                applyFilter();
            } catch (error) {
                console.error('Error loading changelog:', error);
                errorContainer.innerHTML = `<div class="error">Error loading changelog: ${error.message}</div>`;
            } finally {
                loadingContainer.style.display = 'none';
            }
        }

        function applyFilter() {
            const filterType = document.getElementById('filterType').value;

            if (filterType) {
                filteredChanges = allChanges.filter(change => change.changeType === filterType);
            } else {
                filteredChanges = allChanges;
            }

            currentPage = 1;
            displayChanges();
        }

        function displayChanges() {
            const changelogList = document.getElementById('changelogList');
            const noChangesContainer = document.getElementById('noChangesContainer');

            changelogList.innerHTML = '';

            if (filteredChanges.length === 0) {
                noChangesContainer.style.display = 'block';
                return;
            }

            noChangesContainer.style.display = 'none';

            const startIdx = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIdx = startIdx + ITEMS_PER_PAGE;
            const pageChanges = filteredChanges.slice(startIdx, endIdx);

            pageChanges.forEach(change => {
                const listItem = document.createElement('li');
                listItem.className = 'changelog-entry';

                const date = new Date(change.date);
                const formattedDate = date.toLocaleString();

                const typeClass = change.changeType === 'course' ? 'course' : 'major';

                listItem.innerHTML = `
                    <div class="entry-header">
                        <div class="entry-title">Change #${change.id.substring(0, 8)}</div>
                        <span class="entry-type ${typeClass}">${change.changeType.toUpperCase()}</span>
                    </div>
                    <div class="entry-meta">
                        <div class="meta-item">
                            <strong>Date:</strong> ${formattedDate}
                        </div>
                        <div class="meta-item">
                            <strong>Faculty:</strong> ${change.facultyEmail || 'Unknown'}
                        </div>
                    </div>
                    <div class="entry-description">
                        <span class="entry-description-label">Description:</span>
                        ${change.description}
                    </div>
                    <div class="entry-notes">
                        <span class="entry-notes-label">Faculty Notes:</span>
                        ${change.notes ? change.notes : '<span class="empty-notes">No notes provided</span>'}
                    </div>
                    <div class="entry-faculty">
                        ID: ${change.id}
                    </div>
                `;

                changelogList.appendChild(listItem);
            });
        }

        // Student Management Modal Functions
        let currentStudentId = null;
        let currentSubmissionStatus = null;
        let selectedCourses = new Set();
        let courseCache = {};

        async function openStudentModal(studentId, studentName, studentID, submissionStatus) {
            currentStudentId = studentId;
            currentSubmissionStatus = submissionStatus || 'none';
            document.getElementById('modalStudentName').textContent = `${studentName} (${studentID})`;
            document.getElementById('studentModal').classList.add('active');
            selectedCourses.clear();
            document.getElementById('selectedCoursesList').innerHTML = '';
            document.getElementById('courseResults').innerHTML = '';
            document.getElementById('courseSearchInput').value = '';
            document.getElementById('commentText').value = '';
            
            // Show/hide Review Schedule button based on submission status
            const reviewBtn = document.getElementById('reviewScheduleBtn');
            if (reviewBtn) {
                if (currentSubmissionStatus === 'pending') {
                    reviewBtn.style.display = 'block';
                } else {
                    reviewBtn.style.display = 'none';
                }
            }
            
            // Load course cache if not already loaded
            if (Object.keys(courseCache).length === 0) {
                await loadCourseCache();
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('active');
            currentStudentId = null;
            selectedCourses.clear();
        }

        async function loadCourseCache() {
            try {
                const response = await fetch('/api/courses?limit=5000');
                if (!response.ok) throw new Error('Failed to load courses');
                const courses = await response.json();
                
                courses.forEach(course => {
                    const courseId = course.courseID || course.code || course.id;
                    if (courseId) {
                        courseCache[courseId] = course;
                    }
                });
            } catch (error) {
                console.error('Failed to load course cache:', error);
            }
        }

        let searchTimeout = null;
        document.getElementById('courseSearchInput')?.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length < 2) {
                document.getElementById('courseResults').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(() => {
                performCourseSearch(query);
            }, 300);
        });

        function performCourseSearch(query) {
            const resultsDiv = document.getElementById('courseResults');
            const searchTerm = query.toLowerCase();
            
            const filteredCourses = Object.values(courseCache).filter(course => {
                const title = (course.title || '').toLowerCase();
                const courseID = (course.courseID || '').toLowerCase();
                const code = (course.code || '').toLowerCase();
                
                return title.includes(searchTerm) || 
                       courseID.includes(searchTerm) || 
                       code.includes(searchTerm);
            }).slice(0, 20);

            resultsDiv.innerHTML = '';
            
            if (filteredCourses.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #666;">No courses found</div>';
                return;
            }

            filteredCourses.forEach(course => {
                const courseId = course.courseID || course.code || course.id;
                if (!courseId) return;

                const item = document.createElement('div');
                item.className = 'course-result-item';
                item.innerHTML = `
                    <input type="checkbox" id="course-${courseId}" onchange="toggleCourse('${courseId}', '${(course.title || '').replace(/'/g, "\\'")}')">
                    <label for="course-${courseId}" style="cursor: pointer; flex: 1;">
                        <strong>${courseId}</strong> - ${course.title || 'Unknown Course'}
                    </label>
                `;
                resultsDiv.appendChild(item);
            });
        }

        function toggleCourse(courseId, courseTitle) {
            const checkbox = document.getElementById(`course-${courseId}`);
            if (checkbox.checked) {
                selectedCourses.add(courseId);
            } else {
                selectedCourses.delete(courseId);
            }
            updateSelectedCoursesDisplay();
        }

        function updateSelectedCoursesDisplay() {
            const listDiv = document.getElementById('selectedCoursesList');
            listDiv.innerHTML = '';
            
            if (selectedCourses.size === 0) {
                listDiv.innerHTML = '<span style="color: #999;">No courses selected</span>';
                return;
            }

            selectedCourses.forEach(courseId => {
                const course = courseCache[courseId];
                const courseTitle = course ? course.title : 'Unknown Course';
                const tag = document.createElement('span');
                tag.className = 'selected-course';
                tag.innerHTML = `${courseId} - ${courseTitle} <span class="remove-course" onclick="removeSelectedCourse('${courseId}')">×</span>`;
                listDiv.appendChild(tag);
            });
        }

        function removeSelectedCourse(courseId) {
            selectedCourses.delete(courseId);
            const checkbox = document.getElementById(`course-${courseId}`);
            if (checkbox) {
                checkbox.checked = false;
            }
            updateSelectedCoursesDisplay();
        }

        async function saveCompletedCourses() {
            if (!currentStudentId) return;

            try {
                const coursesArray = Array.from(selectedCourses);
                
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/completedCourses`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ courses: coursesArray })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to save courses');
                }

                alert(`Successfully added ${coursesArray.length} course(s) to student's completed courses!`);
                selectedCourses.clear();
                updateSelectedCoursesDisplay();
            } catch (error) {
                console.error('Error saving courses:', error);
                alert('Error saving courses: ' + error.message);
            }
        }

        async function sendComment() {
            if (!currentStudentId) return;

            const commentText = document.getElementById('commentText').value.trim();
            if (!commentText) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment: commentText })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to send comment');
                }

                alert('Comment sent successfully!');
                document.getElementById('commentText').value = '';
            } catch (error) {
                console.error('Error sending comment:', error);
                alert('Error sending comment: ' + error.message);
            }
        }

        async function viewStudentData() {
            if (!currentStudentId) return;

            const viewDataModal = document.getElementById('viewDataModal');
            const completedCoursesList = document.getElementById('completedCoursesList');
            const commentsList = document.getElementById('commentsList');

            viewDataModal.style.display = 'flex';

            try {
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/data`);
                if (!response.ok) {
                    throw new Error('Failed to load student data');
                }

                const data = await response.json();

                // Display completed courses
                if (data.completedCourses && Array.isArray(data.completedCourses) && data.completedCourses.length > 0) {
                    completedCoursesList.innerHTML = data.completedCourses.map(courseId => {
                        const course = courseCache[courseId];
                        const courseTitle = course ? course.title : 'Unknown Course';
                        const escapedCourseId = escapeHtml(courseId);
                        const escapedTitle = escapeHtml(courseTitle);
                        return `
                            <div style="padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div><strong>${escapedCourseId}</strong> - ${escapedTitle}</div>
                                <button class="modal-button" style="background-color: #dc3545; padding: 5px 10px; font-size: 12px; margin: 0;" onclick="removeCompletedCourse('${escapedCourseId}')">Remove</button>
                            </div>
                        `;
                    }).join('');
                } else {
                    completedCoursesList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No completed courses</div>';
                }

                // Display comments
                if (data.comments && Array.isArray(data.comments) && data.comments.length > 0) {
                    // Sort by timestamp (newest first)
                    const sortedComments = [...data.comments].sort((a, b) => {
                        const timeA = a.timestamp?.seconds || 0;
                        const timeB = b.timestamp?.seconds || 0;
                        return timeB - timeA;
                    });

                    commentsList.innerHTML = sortedComments.map(comment => {
                        const date = comment.timestamp ? new Date(comment.timestamp.seconds * 1000) : new Date();
                        const formattedDate = date.toLocaleString();
                        return `
                            <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${escapeHtml(comment.advisorName || 'Advisor')}</strong>
                                    <span style="font-size: 12px; color: #666;">${formattedDate}</span>
                                </div>
                                <div style="color: #333;">${escapeHtml(comment.comment)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    commentsList.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">No comments sent</div>';
                }
            } catch (error) {
                console.error('Error loading student data:', error);
                completedCoursesList.innerHTML = '<div style="color: #c33; text-align: center; padding: 20px;">Error loading data</div>';
                commentsList.innerHTML = '<div style="color: #c33; text-align: center; padding: 20px;">Error loading data</div>';
            }
        }

        function closeViewDataModal() {
            document.getElementById('viewDataModal').style.display = 'none';
        }

        async function removeCompletedCourse(courseId) {
            if (!currentStudentId) return;

            if (!confirm(`Are you sure you want to remove ${courseId} from this student's completed courses?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/completedCourses/${encodeURIComponent(courseId)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to remove course');
                }

                // Reload student data to refresh the list
                await viewStudentData();
            } catch (error) {
                console.error('Error removing course:', error);
                alert('Error removing course: ' + error.message);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Schedule Review Functions
        async function reviewSchedule() {
            if (!currentStudentId) return;

            const reviewModal = document.getElementById('scheduleReviewModal');
            const reviewContent = document.getElementById('reviewScheduleContent');
            const reviewModalStudentName = document.getElementById('reviewModalStudentName');
            
            // Get student name from modal
            const studentName = document.getElementById('modalStudentName').textContent;
            reviewModalStudentName.textContent = `Review Schedule - ${studentName}`;
            
            reviewModal.classList.add('active');
            reviewContent.innerHTML = '<div class="loading">Loading schedule...</div>';

            try {
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/submittedSchedule`);
                if (!response.ok) {
                    throw new Error('Failed to load schedule');
                }

                const data = await response.json();
                const sandbox = data.sandbox;

                if (!sandbox || !sandbox.semesters || sandbox.semesters.length === 0) {
                    reviewContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No schedule submitted.</div>';
                    return;
                }

                // Render schedule similar to sandbox view
                let scheduleHtml = '<div style="display: flex; flex-direction: column; gap: 15px;">';
                
                sandbox.semesters.forEach((semester, index) => {
                    scheduleHtml += `
                        <div style="border: 2px solid #14213D; border-radius: 8px; padding: 15px; background-color: #fafafa;">
                            <div style="font-weight: bold; color: #14213D; font-size: 16px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">
                                ${semester.semester} ${semester.year}
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    `;
                    
                    if (semester.courses && semester.courses.length > 0) {
                        semester.courses.forEach(courseId => {
                            const course = courseCache[courseId];
                            const courseTitle = course ? course.title : 'Unknown Course';
                            scheduleHtml += `
                                <div style="background-color: white; border: 1px solid #ddd; border-radius: 4px; padding: 8px 12px; font-size: 13px;">
                                    <strong style="color: #14213D;">${courseId}</strong> - ${courseTitle}
                                </div>
                            `;
                        });
                    } else {
                        scheduleHtml += '<div style="color: #999; font-style: italic;">No courses scheduled</div>';
                    }
                    
                    scheduleHtml += '</div></div>';
                });
                
                scheduleHtml += '</div>';
                reviewContent.innerHTML = scheduleHtml;

            } catch (error) {
                console.error('Error loading schedule:', error);
                reviewContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #c33;">Error loading schedule: ' + error.message + '</div>';
            }
        }

        function closeScheduleReviewModal() {
            document.getElementById('scheduleReviewModal').classList.remove('active');
            document.getElementById('rejectForm').style.display = 'none';
            document.getElementById('rejectComment').value = '';
        }

        function showRejectForm() {
            document.getElementById('rejectForm').style.display = 'block';
        }

        function hideRejectForm() {
            document.getElementById('rejectForm').style.display = 'none';
            document.getElementById('rejectComment').value = '';
        }

        async function acceptSchedule() {
            if (!currentStudentId) return;

            if (!confirm('Are you sure you want to accept this schedule? It will become the student\'s approved schedule.')) {
                return;
            }

            try {
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/acceptSchedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to accept schedule');
                }

                alert('Schedule accepted successfully!');
                closeScheduleReviewModal();
                closeStudentModal();
                // Reload students to update status
                loadStudents();
            } catch (error) {
                console.error('Error accepting schedule:', error);
                alert('Error accepting schedule: ' + error.message);
            }
        }

        async function rejectSchedule() {
            if (!currentStudentId) return;

            const rejectComment = document.getElementById('rejectComment').value.trim();
            if (!rejectComment) {
                alert('Please enter a reason for rejection.');
                return;
            }

            try {
                const response = await fetch(`/api/secure/advisors/students/${currentStudentId}/rejectSchedule`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment: rejectComment })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to reject schedule');
                }

                alert('Schedule rejected. Comment sent to student.');
                closeScheduleReviewModal();
                closeStudentModal();
                // Reload students to update status
                loadStudents();
            } catch (error) {
                console.error('Error rejecting schedule:', error);
                alert('Error rejecting schedule: ' + error.message);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('studentModal');
            const viewDataModal = document.getElementById('viewDataModal');
            const scheduleReviewModal = document.getElementById('scheduleReviewModal');
            if (event.target === modal) {
                closeStudentModal();
            }
            if (event.target === viewDataModal) {
                closeViewDataModal();
            }
            if (event.target === scheduleReviewModal) {
                closeScheduleReviewModal();
            }
        }

        document.addEventListener('DOMContentLoaded', loadStudents);
    </script>
</body>
</html>